<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Detalle del Incidente</title>
</head>
<body>

<div layout:fragment="content">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>
                        <i class="fas fa-fire mr-2"></i>
                        Detalle del Incidente #<span th:text="${incidente.id}"></span>
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a th:href="@{/incidentes}">Incidentes</a></li>
                        <li class="breadcrumb-item active">Detalle</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <!-- Botones de acción -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-2">
                            <div class="btn-group" role="group">
                                <a th:href="@{/incidentes/{id}/editar(id=${incidente.id})}" 
                                   class="btn btn-warning">
                                    <i class="fas fa-edit mr-1"></i>
                                    Editar
                                </a>
                                <button type="button" 
                                        class="btn btn-danger" 
                                        onclick="confirmarEliminacion()"
                                        th:data-id="${incidente.id}">
                                    <i class="fas fa-trash mr-1"></i>
                                    Eliminar
                                </button>
                                <a th:href="@{/incidentes}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left mr-1"></i>
                                    Volver a la lista
                                </a>
                                <button type="button" class="btn btn-info" onclick="imprimirDetalle()">
                                    <i class="fas fa-print mr-1"></i>
                                    Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Información principal del incidente -->
                <div class="col-md-8">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-info-circle mr-2"></i>
                                Información del Incidente
                            </h3>
                            <div class="card-tools">
                                <span class="badge badge-lg" 
                                      th:classappend="${incidente.estado == 'ACTIVO'} ? 'badge-warning' : 'badge-success'"
                                      th:text="${incidente.estado}"></span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="info-box bg-light">
                                        <span class="info-box-icon">
                                            <i class="fas fa-tag text-primary"></i>
                                        </span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Tipo de Incidente</span>
                                            <span class="info-box-number text-uppercase" th:text="${incidente.tipo}"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box bg-light">
                                        <span class="info-box-icon">
                                            <i class="fas fa-map-marker-alt text-danger"></i>
                                        </span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Ubicación</span>
                                            <span class="info-box-number" th:text="${incidente.ubicacion}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar-check mr-1"></i>Fecha y Hora de Inicio:</label>
                                        <p class="form-control-static">
                                            <span th:if="${incidente.fechaHoraInicio}" 
                                                  th:text="${#temporals.format(incidente.fechaHoraInicio, 'dd/MM/yyyy HH:mm')}"></span>
                                            <span th:unless="${incidente.fechaHoraInicio}" class="text-muted">No especificada</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label><i class="fas fa-calendar-times mr-1"></i>Fecha y Hora de Fin:</label>
                                        <p class="form-control-static">
                                            <span th:if="${incidente.fechaHoraFin}" 
                                                  th:text="${#temporals.format(incidente.fechaHoraFin, 'dd/MM/yyyy HH:mm')}"></span>
                                            <span th:unless="${incidente.fechaHoraFin}" class="text-muted">En curso</span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="row" th:if="${incidente.fechaHoraInicio != null and incidente.fechaHoraFin != null}">
                                <div class="col-md-12">
                                    <div class="info-box bg-info">
                                        <span class="info-box-icon">
                                            <i class="fas fa-clock text-white"></i>
                                        </span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Duración Total</span>
                                            <span class="info-box-number" 
                                                  th:with="duracion=${T(java.time.Duration).between(incidente.fechaHoraInicio, incidente.fechaHoraFin)}"
                                                  th:text="${duracion.toHours() + 'h ' + (duracion.toMinutes() % 60) + 'm'}"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label><i class="fas fa-align-left mr-1"></i>Descripción:</label>
                                <div class="card">
                                    <div class="card-body">
                                        <p th:if="${incidente.descripcion}" th:text="${incidente.descripcion}"></p>
                                        <p th:unless="${incidente.descripcion}" class="text-muted">No hay descripción disponible</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recursos asignados -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-users-cog mr-2"></i>
                                Recursos Asignados
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Personal -->
                                <div class="col-md-4">
                                    <h6><i class="fas fa-users mr-1 text-primary"></i>Personal</h6>
                                    <div th:if="${incidente.personalAsignado != null and !incidente.personalAsignado.isEmpty()}">
                                        <ul class="list-unstyled">
                                            <li th:each="bombero : ${incidente.personalAsignado}" class="mb-2">
                                                <span class="badge badge-primary">
                                                    <i class="fas fa-user mr-1"></i>
                                                    <span th:text="${bombero.nombre + ' ' + bombero.apellido}"></span>
                                                </span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div th:unless="${incidente.personalAsignado != null and !incidente.personalAsignado.isEmpty()}">
                                        <p class="text-muted">Sin personal asignado</p>
                                    </div>
                                </div>

                                <!-- Vehículos -->
                                <div class="col-md-4">
                                    <h6><i class="fas fa-truck mr-1 text-success"></i>Vehículos</h6>
                                    <div th:if="${incidente.vehiculosAsignados != null and !incidente.vehiculosAsignados.isEmpty()}">
                                        <ul class="list-unstyled">
                                            <li th:each="vehiculo : ${incidente.vehiculosAsignados}" class="mb-2">
                                                <span class="badge badge-success">
                                                    <i class="fas fa-truck mr-1"></i>
                                                    <span th:text="${vehiculo.placa + ' - ' + vehiculo.tipo}"></span>
                                                </span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div th:unless="${incidente.vehiculosAsignados != null and !incidente.vehiculosAsignados.isEmpty()}">
                                        <p class="text-muted">Sin vehículos asignados</p>
                                    </div>
                                </div>

                                <!-- Equipos -->
                                <div class="col-md-4">
                                    <h6><i class="fas fa-tools mr-1 text-warning"></i>Equipos</h6>
                                    <div th:if="${incidente.equiposAsignados != null and !incidente.equiposAsignados.isEmpty()}">
                                        <ul class="list-unstyled">
                                            <li th:each="equipo : ${incidente.equiposAsignados}" class="mb-2">
                                                <span class="badge badge-warning">
                                                    <i class="fas fa-tools mr-1"></i>
                                                    <span th:text="${equipo.nombre}"></span>
                                                </span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div th:unless="${incidente.equiposAsignados != null and !incidente.equiposAsignados.isEmpty()}">
                                        <p class="text-muted">Sin equipos asignados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar con fotos y acciones -->
                <div class="col-md-4">
                    <!-- Estadísticas rápidas -->
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line mr-2"></i>
                                Estadísticas
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <div class="small-box bg-info">
                                        <div class="inner">
                                            <h3 th:text="${incidente.personalAsignado != null ? incidente.personalAsignado.size() : 0}"></h3>
                                            <p>Personal</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="small-box bg-success">
                                        <div class="inner">
                                            <h3 th:text="${incidente.vehiculosAsignados != null ? incidente.vehiculosAsignados.size() : 0}"></h3>
                                            <p>Vehículos</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-truck"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="small-box bg-warning">
                                        <div class="inner">
                                            <h3 th:text="${incidente.equiposAsignados != null ? incidente.equiposAsignados.size() : 0}"></h3>
                                            <p>Equipos</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-tools"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="small-box bg-danger">
                                        <div class="inner">
                                            <h3 th:text="${incidente.fotos != null ? incidente.fotos.size() : 0}"></h3>
                                            <p>Fotos</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-images"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Galería de fotos -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-images mr-2"></i>
                                Galería de Fotos
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div th:if="${incidente.fotos != null and !incidente.fotos.isEmpty()}">
                                <div class="row" id="galeria-fotos">
                                    <div class="col-6 mb-3" th:each="foto, iterStat : ${incidente.fotos}">
                                        <div class="position-relative">
                                            <img th:src="@{'/uploads/' + ${foto.nombreArchivo}}" 
                                                 class="img-fluid img-thumbnail foto-thumbnail" 
                                                 alt="Foto del incidente"
                                                 style="cursor: pointer; height: 120px; width: 100%; object-fit: cover;"
                                                 th:onclick="'mostrarFoto(' + ${iterStat.index} + ')'">
                                            <div class="overlay d-flex align-items-center justify-content-center position-absolute w-100 h-100"
                                                 style="top: 0; left: 0; background: rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s;"
                                                 onmouseover="this.style.opacity=1" 
                                                 onmouseout="this.style.opacity=0">
                                                <i class="fas fa-search-plus text-white fa-2x"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="verTodasLasFotos()">
                                        <i class="fas fa-expand mr-1"></i>
                                        Ver todas las fotos
                                    </button>
                                </div>
                            </div>
                            <div th:unless="${incidente.fotos != null and !incidente.fotos.isEmpty()}">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-images fa-3x mb-3"></i>
                                    <p>No hay fotografías disponibles para este incidente</p>
                                    <a th:href="@{/incidentes/{id}/editar(id=${incidente.id})}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus mr-1"></i>
                                        Agregar fotos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Línea de tiempo -->
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-clock mr-2"></i>
                                Línea de Tiempo
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="time-label" th:if="${incidente.fechaHoraInicio}">
                                    <span class="bg-green" th:text="${#temporals.format(incidente.fechaHoraInicio, 'dd/MM/yyyy')}"></span>
                                </div>
                                
                                <div th:if="${incidente.fechaHoraInicio}">
                                    <i class="fas fa-play bg-success"></i>
                                    <div class="timeline-item">
                                        <span class="time">
                                            <i class="fas fa-clock mr-1"></i>
                                            <span th:text="${#temporals.format(incidente.fechaHoraInicio, 'HH:mm')}"></span>
                                        </span>
                                        <h3 class="timeline-header text-success">Inicio del incidente</h3>
                                        <div class="timeline-body">
                                            Incidente reportado y recursos desplegados
                                        </div>
                                    </div>
                                </div>
                                
                                <div th:if="${incidente.fechaHoraFin}">
                                    <i class="fas fa-stop bg-danger"></i>
                                    <div class="timeline-item">
                                        <span class="time">
                                            <i class="fas fa-clock mr-1"></i>
                                            <span th:text="${#temporals.format(incidente.fechaHoraFin, 'HH:mm')}"></span>
                                        </span>
                                        <h3 class="timeline-header text-danger">Fin del incidente</h3>
                                        <div class="timeline-body">
                                            Incidente resuelto y recursos liberados
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <i class="fas fa-clock bg-gray"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal para galería de fotos -->
    <div class="modal fade" id="fotoModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-dark">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-images mr-2"></i>
                        Galería del Incidente #<span th:text="${incidente.id}"></span>
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0">
                    <div id="carouselFotos" class="carousel slide" data-ride="carousel">
                        <div class="carousel-inner">
                            <div th:each="foto, iterStat : ${incidente.fotos}" 
                                 class="carousel-item"
                                 th:classappend="${iterStat.first} ? 'active'">
                                <img th:src="@{'/uploads/' + ${foto.nombreArchivo}}" 
                                     class="d-block w-100" 
                                     alt="Foto del incidente"
                                     style="max-height: 70vh; object-fit: contain;">
                            </div>
                        </div>
                        <a class="carousel-control-prev" href="#carouselFotos" role="button" data-slide="prev" 
                           th:if="${incidente.fotos != null and incidente.fotos.size() > 1}">
                            <span class="carousel-control-prev-icon"></span>
                        </a>
                        <a class="carousel-control-next" href="#carouselFotos" role="button" data-slide="next"
                           th:if="${incidente.fotos != null and incidente.fotos.size() > 1}">
                            <span class="carousel-control-next-icon"></span>
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times mr-1"></i>
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="page-scripts">
    <script>
        let fotosIncidente = [];
        
        // Inicializar array de fotos
        document.addEventListener('DOMContentLoaded', function() {
            // Construir array de fotos desde Thymeleaf
            fotosIncidente = [
                /*[# th:each="foto : ${incidente.fotos}"]*/
                {
                    url: /*[[@{'/uploads/' + ${foto.nombreArchivo}}]]*/ '',
                    nombre: /*[[${foto.nombreArchivo}]]*/ ''
                }/*[# th:if="!${iterStat.last}"]*/,/*[/]*/
                /*[/]*/
            ];
        });

        function mostrarFoto(index) {
            $('#carouselFotos').carousel(index);
            $('#fotoModal').modal('show');
        }

        function verTodasLasFotos() {
            $('#fotoModal').modal('show');
        }

        function confirmarEliminacion() {
            const incidenteId = /*[[${incidente.id}]]*/ 0;
            
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'Esta acción eliminará permanentemente el incidente y todas sus fotos asociadas',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/incidentes/${incidenteId}/eliminar`;
                }
            });
        }

        function imprimirDetalle() {
            // Crear una nueva ventana para imprimir
            const printWindow = window.open('', '_blank');
            const incidenteData = {
                id: /*[[${incidente.id}]]*/ '',
                tipo: /*[[${incidente.tipo}]]*/ '',
                ubicacion: /*[[${incidente.ubicacion}]]*/ '',
                estado: /*[[${incidente.estado}]]*/ '',
                descripcion: /*[[${incidente.descripcion ?: 'Sin descripción'}]]*/ '',
                fechaInicio: /*[[${incidente.fechaHoraInicio ? #temporals.format(incidente.fechaHoraInicio, 'dd/MM/yyyy HH:mm') : 'No especificada'}]]*/ '',
                fechaFin: /*[[${incidente.fechaHoraFin ? #temporals.format(incidente.fechaHoraFin, 'dd/MM/yyyy HH:mm') : 'En curso'}]]*/ ''
            };

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Detalle del Incidente #${incidenteData.id}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
                        .section { margin: 20px 0; }
                        .label { font-weight: bold; }
                        .value { margin-left: 10px; }
                        .status { padding: 5px 10px; border-radius: 5px; }
                        .status.activo { background-color: #fff3cd; color: #856404; }
                        .status.cerrado { background-color: #d4edda; color: #155724; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>DETALLE DEL INCIDENTE #${incidenteData.id}</h1>
                        <p>Fecha de impresión: ${new Date().toLocaleString('es-ES')}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Información General</h2>
                        <p><span class="label">Tipo:</span><span class="value">${incidenteData.tipo}</span></p>
                        <p><span class="label">Estado:</span><span class="value status ${incidenteData.estado.toLowerCase()}">${incidenteData.estado}</span></p>
                        <p><span class="label">Ubicación:</span><span class="value">${incidenteData.ubicacion}</span></p>
                    </div>
                    
                    <div class="section">
                        <h2>Fechas y Horarios</h2>
                        <p><span class="label">Inicio:</span><span class="value">${incidenteData.fechaInicio}</span></p>
                        <p><span class="label">Fin:</span><span class="value">${incidenteData.fechaFin}</span></p>
                    </div>
                    
                    <div class="section">
                        <h2>Descripción</h2>
                        <p>${incidenteData.descripcion}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Efecto hover para las fotos
        document.addEventListener('DOMContentLoaded', function() {
            const thumbnails = document.querySelectorAll('.foto-thumbnail');
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('mouseover', function() {
                    this.style.transform = 'scale(1.05)';
                    this.style.transition = 'transform 0.3s ease';
                });
                
                thumbnail.addEventListener('mouseout', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        });
    </script>
</th:block>

</body>
</html>
