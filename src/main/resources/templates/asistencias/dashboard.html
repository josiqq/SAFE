<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{fragments/layout}">

<head>
    <title>Dashboard de Asistencias</title>
</head>

<body>

    <div layout:fragment="content">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>
                            <i class="fas fa-chart-line mr-2"></i>
                            Dashboard de Asistencias
                        </h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a th:href="@{/asistencias}">Asistencias</a></li>
                            <li class="breadcrumb-item active">Dashboard</li>
                        </ol>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <div class="row">
                    <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                        <div class="info-box bg-success">
                            <span class="info-box-icon"><i class="fas fa-user-check"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Presentes Hoy</span>
                                <span class="info-box-number" th:text="${estadisticasHoy.get('PRESENTE') ?: 0}">0</span>
                                <div class="progress">
                                    <div class="progress-bar"
                                        th:style="'width: ' + (${estadisticasHoy.get('PRESENTE') ?: 0} * 100.0 / ${totalBomberos}) + '%'">
                                    </div>
                                </div>
                                <span class="progress-description">
                                    <span th:text="${#numbers.formatDecimal((estadisticasHoy.get('PRESENTE') ?: 0) * 100.0 / totalBomberos, 1, 1)}">0</span>%
                                    del total
                                </span>
                            </div>
                        </div>
                    </div>
                
                    <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                        <div class="info-box bg-danger">
                            <span class="info-box-icon"><i class="fas fa-user-times"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Ausentes Hoy</span>
                                <span class="info-box-number" th:text="${estadisticasHoy.get('AUSENTE') ?: 0}">0</span>
                                <div class="progress">
                                    <div class="progress-bar bg-danger"
                                        th:style="'width: ' + (${estadisticasHoy.get('AUSENTE') ?: 0} * 100.0 / ${totalBomberos}) + '%'">
                                    </div>
                                </div>
                                <span class="progress-description">
                                    <span th:text="${#numbers.formatDecimal((estadisticasHoy.get('AUSENTE') ?: 0) * 100.0 / totalBomberos, 1, 1)}">0</span>%
                                    del total
                                </span>
                            </div>
                        </div>
                    </div>
                
                    <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                        <div class="info-box bg-warning">
                            <span class="info-box-icon"><i class="fas fa-exclamation-triangle"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Justificados</span>
                                <span class="info-box-number"
                                    th:text="${estadisticasHoy.get('JUSTIFICADO') ?: 0}">0</span>
                                <div class="progress">
                                    <div class="progress-bar bg-warning"
                                        th:style="'width: ' + (${estadisticasHoy.get('JUSTIFICADO') ?: 0} * 100.0 / ${totalBomberos}) + '%'">
                                    </div>
                                </div>
                                <span class="progress-description">Faltas justificadas</span>
                            </div>
                        </div>
                    </div>
                
                    <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                        <div class="info-box bg-info">
                            <span class="info-box-icon"><i class="fas fa-clock"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Con Retraso</span>
                                <span class="info-box-number" th:text="${estadisticasHoy.get('RETRASO') ?: 0}">0</span>
                                <div class="progress">
                                    <div class="progress-bar bg-info"
                                        th:style="'width: ' + (${estadisticasHoy.get('RETRASO') ?: 0} * 100.0 / ${totalBomberos}) + '%'">
                                    </div>
                                </div>
                                <span class="progress-description">Llegadas tarde</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-pie mr-2"></i>
                                    Distribución de Asistencias - Este Mes
                                </h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="pieChart"
                                    style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card card-success">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-trophy mr-2"></i>
                                    Top 5 - Mejor Asistencia del Mes
                                </h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Posición</th>
                                                <th>Bombero</th>
                                                <th>Días Presente</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="entry, iterStat : ${topBomberos}">
                                                <td>
                                                    <span th:switch="${iterStat.index}" class="badge">
                                                        <span th:case="0" class="badge badge-warning">
                                                            <i class="fas fa-trophy"></i> 1°
                                                        </span>
                                                        <span th:case="1" class="badge badge-secondary">
                                                            <i class="fas fa-medal"></i> 2°
                                                        </span>
                                                        <span th:case="2" class="badge badge-secondary">
                                                            <i class="fas fa-medal"></i> 3°
                                                        </span>
                                                        <span th:case="*" class="badge badge-light"
                                                            th:text="${iterStat.index + 1} + '°'">4°</span>
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="user-avatar mr-2">
                                                            <div class="img-circle bg-primary d-flex align-items-center justify-content-center"
                                                                style="width: 25px; height: 25px; font-size: 10px;">
                                                                <i class="fas fa-user text-white"></i>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <strong
                                                                th:text="${entry.key.nombre + ' ' + entry.key.apellido}">Nombre</strong>
                                                            <div class="text-muted small"
                                                                th:text="${entry.key.username}">username</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge badge-success" th:text="${entry.value}">0</span>
                                                </td>
                                                <td>
                                                    <div class="progress progress-sm">
                                                        <div class="progress-bar bg-success"
                                                            th:style="'width: ' + (${entry.value} * 100 / 30) + '%'">
                                                        </div>
                                                    </div>
                                                    <small class="text-muted" th:text="${#numbers.formatDecimal(entry.value * 100.0 / 30, 1, 1)} + '%'">95%</small>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card card-info">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-calendar-week mr-2"></i>
                                    Tendencia de Asistencias - Últimos 7 Días
                                </h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-tool" onclick="actualizarGraficoSemanal()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart">
                                    <canvas id="lineChart"
                                        style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="card card-light">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-bolt mr-2"></i>
                                    Acciones Rápidas
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="/asistencias/registrar" class="btn btn-primary mb-2">
                                        <i class="fas fa-plus mr-2"></i>
                                        Registrar Asistencia
                                    </a>
                                    <a href="/asistencias" class="btn btn-secondary mb-2">
                                        <i class="fas fa-list mr-2"></i>
                                        Ver Todas las Asistencias
                                    </a>
                                    <button class="btn btn-info mb-2" onclick="exportarReporte()">
                                        <i class="fas fa-download mr-2"></i>
                                        Exportar Reporte Mensual
                                    </button>
                                    <button class="btn btn-warning" onclick="mostrarAlertasAsistencia()">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        Alertas de Ausentismo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card card-warning">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Alertas y Notificaciones
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="alertasContainer">
                                    <div class="alert alert-info" role="alert">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        <strong>Sistema actualizado:</strong> Los datos se actualizan automáticamente
                                        cada 5 minutos.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <th:block layout:fragment="page-scripts">
        <script src="@{/plugins/chart.js/Chart.min.js}"></script>
        <script>
            let pieChart, lineChart;

            $(document).ready(function () {
                inicializarGraficos();
                cargarAlertasAsistencia();

                // Auto-actualización cada 5 minutos
                setInterval(function () {
                    actualizarDashboard();
                }, 300000);
            });

            function inicializarGraficos() {
                // Gráfico de pastel - distribución del mes
                const pieChartCanvas = document.getElementById('pieChart').getContext('2d');
                const pieData = {
                    labels: ['Presentes', 'Ausentes', 'Justificados', 'Retrasos'],
                    datasets: [{
                        data: [
                            [[${ estadisticasMes.get('PRESENTE') ?: 0 }]],
                            [[${ estadisticasMes.get('AUSENTE') ?: 0 }]],
                            [[${ estadisticasMes.get('JUSTIFICADO') ?: 0 }]],
                            [[${ estadisticasMes.get('RETRASO') ?: 0 }]]
                        ],
                        backgroundColor: [
                            '#28a745', // Verde para presente
                            '#dc3545', // Rojo para ausente
                            '#ffc107', // Amarillo para justificado
                            '#17a2b8'  // Azul para retraso
                        ]
                    }]
                };

                pieChart = new Chart(pieChartCanvas, {
                    type: 'doughnut',
                    data: pieData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Gráfico de línea - tendencia semanal
                inicializarGraficoLinea();
            }

            function inicializarGraficoLinea() {
                const lineChartCanvas = document.getElementById('lineChart').getContext('2d');

                // Datos simulados para los últimos 7 días
                const labels = [];
                const datosPresentes = [];
                const datosAusentes = [];

                // Generar etiquetas de fechas para los últimos 7 días
                for (let i = 6; i >= 0; i--) {
                    const fecha = new Date();
                    fecha.setDate(fecha.getDate() - i);
                    labels.push(fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' }));

                    // Datos simulados (en implementación real vendrían del servidor)
                    datosPresentes.push(Math.floor(Math.random() * 20) + 10);
                    datosAusentes.push(Math.floor(Math.random() * 8) + 1);
                }

                const lineData = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Presentes',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderColor: '#28a745',
                            pointBackgroundColor: '#28a745',
                            data: datosPresentes,
                            fill: true
                        },
                        {
                            label: 'Ausentes',
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            borderColor: '#dc3545',
                            pointBackgroundColor: '#dc3545',
                            data: datosAusentes,
                            fill: true
                        }
                    ]
                };

                lineChart = new Chart(lineChartCanvas, {
                    type: 'line',
                    data: lineData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            function actualizarGraficoSemanal() {
                // En implementación real, esto haría una llamada AJAX
                Swal.fire({
                    icon: 'info',
                    title: 'Actualizando...',
                    text: 'Obteniendo datos más recientes',
                    timer: 2000,
                    showConfirmButton: false
                });

                // Simular actualización de datos
                setTimeout(() => {
                    lineChart.data.datasets[0].data = lineChart.data.datasets[0].data.map(() =>
                        Math.floor(Math.random() * 20) + 10);
                    lineChart.data.datasets[1].data = lineChart.data.datasets[1].data.map(() =>
                        Math.floor(Math.random() * 8) + 1);
                    lineChart.update();
                }, 1000);
            }

            function cargarAlertasAsistencia() {
                // En implementación real, esto cargaría alertas desde el servidor
                const alertasContainer = document.getElementById('alertasContainer');

                // Simular algunas alertas
                const alertasEjemplo = [
                    {
                        tipo: 'warning',
                        icono: 'fas fa-exclamation-triangle',
                        titulo: 'Ausentismo alto',
                        mensaje: '3 bomberos han faltado más de 2 días consecutivos esta semana.'
                    },
                    {
                        tipo: 'info',
                        icono: 'fas fa-clock',
                        titulo: 'Retrasos frecuentes',
                        mensaje: 'Se han registrado 8 llegadas tarde en los últimos 3 días.'
                    }
                ];

                alertasEjemplo.forEach(alerta => {
                    const alertHTML = `
                    <div class="alert alert-${alerta.tipo}" role="alert">
                        <i class="${alerta.icono} mr-2"></i>
                        <strong>${alerta.titulo}:</strong> ${alerta.mensaje}
                    </div>
                `;
                    alertasContainer.insertAdjacentHTML('beforeend', alertHTML);
                });
            }

            function actualizarDashboard() {
                // En implementación real, esto actualizaría todos los datos
                console.log('Actualizando dashboard...');
            }

            function exportarReporte() {
                Swal.fire({
                    title: 'Generar Reporte',
                    text: '¿Qué formato desea para el reporte mensual?',
                    icon: 'question',
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: 'Excel',
                    denyButtonText: 'PDF',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/asistencias/export/excel?mes=actual';
                    } else if (result.isDenied) {
                        window.location.href = '/asistencias/export/pdf?mes=actual';
                    }
                });
            }

            function mostrarAlertasAsistencia() {
                Swal.fire({
                    title: 'Alertas de Ausentismo',
                    html: `
                    <div class="text-left">
                        <h6>Bomberos con patrones de ausentismo:</h6>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Juan Pérez
                                <span class="badge badge-danger badge-pill">3 días</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                María García
                                <span class="badge badge-warning badge-pill">2 días</span>
                            </li>
                        </ul>
                    </div>
                `,
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
            }
        </script>
    </th:block>

</body>

</html>